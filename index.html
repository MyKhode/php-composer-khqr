<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KHQR Membership Payment</title>
<style>
  :root {
    --primary: #007bff;
    --bg: #0d0d0f;
    --card: #1a1a1d;
    --text: #f1f1f1;
    --accent: #ffd700;
  }

  body {
    font-family: 'Inter', Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 30px 15px;
    display: flex;
    justify-content: center;
  }

  .container {
    max-width: 420px;
    width: 100%;
  }

  h1 {
    text-align: center;
    color: var(--text);
    font-weight: 600;
    margin-bottom: 25px;
  }

  .product {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card);
    padding: 16px 18px;
    border-radius: 12px;
    margin-bottom: 12px;
    transition: background 0.3s;
  }

  .product:hover { background: #222227; }

  .info { text-align: left; }

  .info h3 {
    margin: 0;
    font-size: 1rem;
    text-transform: capitalize;
  }

  .info span {
    font-size: 0.85rem;
    color: #aaa;
  }

  .price {
    font-weight: bold;
    font-size: 1.1rem;
    margin-right: 8px;
  }

  .btn {
    background: var(--primary);
    border: none;
    color: #fff;
    padding: 7px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: 0.2s;
  }

  .btn:hover { background: #0056b3; }

  /* === Modal Common === */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #18181b;
    border-radius: 12px;
    padding: 25px 30px;
    text-align: center;
    width: 90%;
    max-width: 400px;
    position: relative; /* âœ… Added so close button stays positioned */
  }

  /* === Close Button === */
  .close-btn {
    position: absolute;
    top: 12px;
    right: 14px;
    background: none;
    border: none;
    color: #ccc;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.2s;
  }

  .close-btn:hover { color: #fff; }

  #qrImage {
    margin: 20px 0;
    width: 220px;
    height: 220px;
  }

  #status {
    font-size: 15px;
    color: #ccc;
  }

  /* Success Modal */
  #successModal .modal-content { background: #121212; }

  #licenseKey {
    background: #222;
    color: #0f0;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    font-family: monospace;
  }

  .copy-btn {
    background: var(--accent);
    border: none;
    color: #000;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
  }

  .copy-btn:hover { opacity: 0.9; }
</style>
</head>
<body>
  <div class="container">
    <h1>Choose Your Plan</h1>

    <div class="product">
      <div class="info">
        <h3>ðŸ¥‰ Bronze</h3>
        <span>14 days</span>
      </div>
      <div>
        <span class="price">$0.05</span>
        <button class="btn" onclick="payNow('Bronze', 0.05)">Pay Now</button>
      </div>
    </div>

    <div class="product">
      <div class="info">
        <h3>ðŸ¥ˆ Silver User</h3>
        <span>30 days</span>
      </div>
      <div>
        <span class="price">$0.10</span>
        <button class="btn" onclick="payNow('Silver User', 0.10)">Pay Now</button>
      </div>
    </div>

    <div class="product">
      <div class="info">
        <h3>ðŸ¥‡ Gold Card</h3>
        <span>90 days</span>
      </div>
      <div>
        <span class="price">$0.15</span>
        <button class="btn" onclick="payNow('Gold Card', 0.15)">Pay Now</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <!-- âœ… Now clearly visible close button -->
      <button class="close-btn" onclick="closeQRModal()">âœ–</button>
      <h2>Scan to Pay</h2>
      <img id="qrImage" alt="KHQR Code">
      <p id="status"></p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">âœ–</button>
      <h2>Purchase Successful ðŸŽ‰</h2>
      <p id="productName"></p>
      <p id="productPrice"></p>
      <div id="licenseKey"></div>
      <button class="copy-btn" onclick="copyLicense()">Copy License Key</button>
    </div>
  </div>

<script>
let pollingInterval = null;
let currentProduct = null;
let currentLicenseKey = '';

async function payNow(name, amount) {
  currentProduct = { name, amount };
  document.getElementById('qrModal').style.display = 'flex';
  document.getElementById('status').textContent = 'Generating QR...';

  if (pollingInterval) clearInterval(pollingInterval);

  try {
    const response = await fetch('/generate-khqr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount,
        transactionId: 'TX' + Date.now()
      })
    });

    const data = await response.json();
    if (data.qrCodeData) {
      const img = document.getElementById('qrImage');
      img.src = data.qrCodeData;
      document.getElementById('status').textContent = 'Scan QR using Bakong app to complete payment';
      pollPaymentStatus(data.md5, data.transactionId, amount);
    } else {
      document.getElementById('status').textContent = 'Error: ' + data.error;
      document.getElementById('status').className = 'error';
    }
  } catch (err) {
    document.getElementById('status').textContent = 'Error generating QR';
    document.getElementById('status').className = 'error';
  }
}

function pollPaymentStatus(md5, transactionId, amount) {
  pollingInterval = setInterval(async () => {
    try {
      const res = await fetch('/check-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ md5, transactionId, amount })
      });
      const data = await res.json();
      if (data.status === 'success') {
        clearInterval(pollingInterval);
        closeQRModal();
        showSuccessModal(currentProduct);
      }
    } catch {}
  }, 4000);
}

function showSuccessModal(product) {
  document.getElementById('successModal').style.display = 'flex';
  document.getElementById('productName').textContent = `License: ${product.name}`;
  document.getElementById('productPrice').textContent = `Price: $${product.amount}`;
  currentLicenseKey = 'LIC-' + Math.random().toString(36).substring(2, 10).toUpperCase();
  document.getElementById('licenseKey').textContent = currentLicenseKey;
}

function copyLicense() {
  navigator.clipboard.writeText(currentLicenseKey);
  alert('License key copied!');
}

function closeModal() {
  document.getElementById('successModal').style.display = 'none';
}

function closeQRModal() {
  document.getElementById('qrModal').style.display = 'none';
  document.getElementById('qrImage').src = '';
  document.getElementById('status').textContent = '';
}
</script>
</body>
</html>
